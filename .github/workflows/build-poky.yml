name: Build Poky

on: workflow_dispatch

jobs:
  build:
    # this can be assigned to a more powerful runner to improve build time
    runs-on: self-hosted

    # use the builder container
    container: 
      image: ghcr.io/${{ github.repository_owner }}/yoctoresearch/yocto-builder:latest
      options: --user root
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

        
      #- name: Initialize Enviornment
      #  run: source oe-init-build-env build
      
      - name: Change Ownership of the Workspace
        run: |
          chown -R builder:builder $GITHUB_WORKSPACE

      # Cache the downloads and sstate-cache directories
      - name: Restore Yocto downloads and sstate-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            $GITHUB_WORKSPACE/build/downloads
            $GITHUB_WORKSPACE/build/sstate-cache
          key: ${{ runner.os }}-yocto-cache

      # build the image
      - name: Build
        shell: bash
        run: |
          su - builder -c "
            cd $GITHUB_WORKSPACE
            source oe-init-build-env build
            bitbake core-image-dummy
          "

      # Cache the downloads and sstate-cache directories
      - name: Save Yocto downloads and sstate-cache
        uses: actions/cache/save@v4
        with:
          path: |
            $GITHUB_WORKSPACE/build/downloads
            $GITHUB_WORKSPACE/build/sstate-cache
          key: ${{ runner.os }}-yocto-cache

      # save the image by uploading artifact
      - name: Save Image
        uses: actions/upload-artifact@v4
        with:
          name: yocto-images
          path: |
            $GITHUB_WORKSPACE/build/tmp/deploy/images/**/core-image-*.{wic,ext4,tar.gz,bin,rootfs.*}
            
